# Настройка окружения

Дальше описаны шаги, которые вам нужно предпринять, для того чтобы получать новые задачки,
решать их и отправлять на проверку.

Вам нужно будет пройти следующие шаги:

- [Регистрация](#register)
- [Настройка системы](#pre)
- [Настройка git репозитория](#git)
- [Установка bazel, компиляторов, clang-tidy, clang-format](#install)
- [Настройка IDE](#ide)
- [Сдача заданий](#send)

---

## Регистрация <a id='register'/>

Прежде всего вам надо зарегистрироваться на [bsu-cpp.manytask.org](https://bsu-cpp.manytask.org/).

Если вы уже регистрировались в системе manytask на других курсах ШАД, например, курс С++, то у вас
уже есть аккаунт, и можно просто нажать "Login".

Если вы не помните или не уверены, то можете попробовать зарегистрироваться, и в случае, если такой
пользователь уже
имеется, получите сообщение об ошибке: "Email has already been taken". В таком случае тоже смело
жмите "Login".

Кодовое слово, необходимое при регистрации спрашивайте у преподавателей.

Далее вы попадете на [gitlab.manytask.org](https://gitlab.manytask.org/), где должны будете
залогиниться, используя логин-пароль, который вы вводили в форму регистрации ранее.
Если вы проходили эту процедуру ранее для других курсов, и гитлаб вас помнит, то этот шаг
автоматически будет пропущен.

В итоге вы должны попасть на главную bsu-cpp.manytask.org:

![title](https://i.imgur.com/Q4OxyMq.png "Manytask")

## Настройка системы <a id='pre'/>

В инструкции все команды, которые нужно вводить начинаются с знака `$` вам нужно копировать и исполнять всё после него.
`#` - обозначается комментарий, который только для информации.

Для решения задач вам потребуется компьютер с Unix окружением. Лучше всего использовать Linux.
OSX тоже будет нормально работать.

<details> <summary><a>MacOS</a></summary>

В MacOS не хватает менеджера пакетов для удобно установки чего-либо (по типу apt-get).

Поэтому нужно установить `brew` по [официальной инструкции](https://brew.sh/).

```shell
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

</details>

<details><summary><a>Windows</a></summary>

В Windows 10 появилась такая фича как WSL: Windows Subsystem for Linux,
с её помощью можно запускать Linux-приложения на Windows.
Мы рекомендуем воспользоваться ею, и в дальнейшем следовать инструкциям,
как будто бы у вас стоит операционная система Linux.

Установить `wsl` нужно по [официальной
инструкции](https://docs.microsoft.com/ru-ru/windows/wsl/install-win10
)
Можно использовать Windows, но для компиляции и запуска потребуется WSL (Windows Subsystem for Linux).
В этом случае сначала установите WSL, а дальнейшие инструкции выполняйте уже в Linux окружении.

Рекомендуется использовать Linux Ubuntu версии **22.04**. Тестирующая система проверяет задачи
на этой версии убунты, и если вы будете использовать эту же версию локально, то вы избежите
проблем со старыми версиями компиляторов.

Запустите установленную систему. При входе вы окажетесь в директории `/home/<username>`;
для того, чтобы иметь возможность работать с кодом из самой Windows (например, в Clion),
мы рекомендуем размещать директорию с задачами по адресу `"/mnt/c/Users/<username>/My Documents"`,
которая в самой Windows доступна по адресу `C:\Users\<username>\My Documents`.

Перейдите в указанную директорию:

```bash
cd "/mnt/c/Users/<username>/My Documents"
```

Следуйте по инструкции дальше

</details>

## Настройка git репозитория <a id='git'/>

Вся работа по получению, решению и сдаче заданий происходит через git репозиторий. Для начала нужно
его получить, скачать и настроить доступ.
О том, что такое гит, и как вообще с ним работать, рассказывают тут -- [лекции про
гит](https://yadi.sk/i/YUe3SJYo11EChA).

### Установка необходимого

Нам нужно установить ssh-keygen (если его нет) и git.
С некоторой вероятностью они уже стоят, проверить можно так:

```shell
git --version
ssh-keygen --help
```

Если же нет, то устанавливаем
<details><summary><a>Linux</a></summary>

Если у вас Ubuntu/Debian, то всё просто:

```bash
# Если не стоит ssh-keygen:
sudo apt-get install openssh-client
```

```bash
sudo apt-get install git
```

Если у вас другой дистрибутив, то считается, вы и сами знаете, как в нем поставить пакет.
</details>

<details><summary><a>MacOS</a></summary>

В MacOS по-умолчанию уже установлен `ssh-keygen`, а если вы ставили `xcode`, то и `git`

Если же вам хочется поставить git отдельно, то ставим его через brew:

```bash
brew install git
```

</details>

### Создание ssh-ключа

Можно почитать [туториал гитлаба](https://docs.gitlab.com/ce/user/ssh.html) о том как создать и добавить в аккаунт ssh ключ, а можно проследовать инструкции ниже.
Если вы используете инструкцию гитлаба, не забудьте пройти также по ссылке [declare what host](https://gitlab.manytask.org/help/ssh/README#working-with-non-default-ssh-key-pair-paths),
где описано как указать какой ключ использовать для подключения к гитлабу.

Если же вы уже были участником других курсов с manytask, то, скорее всего, этот ключ у вас уже есть и
или можно создать дополнительный или использовать старый (см. пункт "Как проверить себя?")

Если вы не делали по инструкции гитлаба:

- Воспользуйтесь `ssh-keygen` (возможно, вам придется поставить `openssh-client`), затем скопируйте **.pub** ключ:

  ```bash
  # Создаем ключ:
  ssh-keygen -t ed25519 -f ~/.ssh/manytask_ed25519
  # TODO(sokolik): ssh-keygen -N "" -f ~/.ssh/id_rsa
  # Обратите внимание, что вы можете не указывать пароль для ключа,
  # чтобы не приходилось его потом вводить на каждое действие c ключом
  # Это стандартная практика, хотя и не очень безопасная

  # Выводим содержимое **публичного** ключа в консоль:
  cat ~/.ssh/manytask_ed25519.pub
  # ...
  # Его надо просто скопировать, как есть, включая подпись - обычно это "ваш-логин@имя-устройства"
  # ВАЖНО! Публичным ключом можно делиться, приватным (то же имя, без .pub на конце) - никогда,
  # иначе злоумышленник сможет представиться вами
  ```

<details><summary><a>Картинка</a></summary><img src="https://i.imgur.com/FMHgxsL.png" width=800/></details></br>

- Идете на [gitlab.manytask.org](https://gitlab.manytask.org/)

- Жмете на иконку с вашим профилем в правом верхнем углу -> `Settings` -> слева жмете на `SSH keys`

- Вставляете ключ в формочку, жмете "Add key"

  <details><summary><a>Картинка</a></summary><img src="https://i.imgur.com/CSPBoGp.png" width=800/></details></br>

- Создайте ssh-config с таким содержимым, чтобы при подключении к `gitlab.manytask.org` использовался ваш новый ключ:

  ```bash
  $ cat ~/.ssh/config
  Host gitlab.manytask.org
    IdentityFile ~/.ssh/manytask_ed25519
  ```

  Создать файл можно с помощью редактора `nano`, если он установлен

  ```bash
  nano ~/.ssh/config
  ```

  Затем нужно вставить в файл содержимое и нажать ctrl + O для сохранения и ctrl + X для выхода из редактора.

  Либо с помощью команды

  ```bash
  echo $'Host gitlab.manytask.org\n\tIdentityFile ~/.ssh/manytask_ed25519' > ~/.ssh/config
  ```

<details><summary><a>Как проверить себя?</a></summary>

Проверьте, что ssh ключ работает. Выполните команду `ssh git@gitlab.manytask.org` (На вопрос "Are you sure you want to continue connecting (yes/no/[fingerprint])?" ответьте 'yes'). Вы должны увидеть такое приветствие:

   ```bash
   $ ssh git@gitlab.manytask.org
   PTY allocation request failed on channel 0
   Welcome to GitLab, USERNAME!
   Connection to gitlab.manytask.org closed.
   ```

</details>

Если что-то не получилось - обращайтесь в телеграм-чат.

### Клонирование и настройка репозитория

```bash
# Переходим в директорию, где вы хотите разместить репозиторий с задачами,
# обычно это домашняя директория - `/home/<username>` или /Users/<username>, она же обозначается как `~` (это тильда, если что)
cd <твоя выбранная директория>

# Клонируем свой репозиторий с gitlab.manytask.org (создается автоматически при регистрации)
# Имя репозитория доступно по ссылке **MY REPO** на bsu-cpp.manytask.org
# Нажмите на синию кнопку **Clone** и скопируйте SSH адрес(как ссылка ниже)
git clone git@gitlab.manytask.org:bsu-cpp/students-2023-spring/<твой репозиторий>

# Переходим в директорию склонированного репозитория
cd <твой репозиторий(по умолчанию ваш ник)>

# Настраиваем гит так, чтобы он знал нас "в лицо"
git config --local user.name "<твой логин с bsu-cpp.manytask.org>"
git config --local user.email "<твой email с bsu-cpp.manytask.org>"

# Настраиваем возможность получать обновления из публичного репозитория с задачами
git remote add upstream git@gitlab.manytask.org:bsu-cpp/public-2023-spring.git
```

## Установка bazel, компиляторов, clang-tidy, clang-format <a id='install'/>

Linux:

- **g++-13**

  ```bash
  sudo apt-get install g++-13
  ```

- **clang++-17 (and  clang-tidy, clang-format)**

  ```bash
  wget https://apt.llvm.org/llvm.sh
  chmod +x llvm.sh
  sudo ./llvm.sh 17 all
  ```

MacOs:

```bash
brew install gcc@13 llvm git bazel clang-format

# https://stackoverflow.com/a/53380855
ln -s "$(brew --prefix llvm)/bin/clang-tidy" "/usr/local/bin/clang-tidy"
ln -s "$(brew --prefix llvm)/bin/clang-apply-replacements" "/usr/local/bin/clang-apply-replacements"
```
[Asan работать скорее всего не будет](https://github.com/google/sanitizers/issues/1026). Вы можете отключить проверку на утечки в файле `.bazelrc` строчку с `...ASAN_OPTIONS=detect_leaks=1:dete...` на `...ASAN_OPTIONS=detect_leaks=0:dete...`. Тогда в режиме asan проверится некоторое подмножество ошибок.
Поэтому сборка с ним и строчка скрипта *run_linter.sh*  вида `bazel run...` работать не будут (можно удалить её вместе с обрамляющим if-ом).

## Установка и настройка IDE <a id='ide'/>

1. Настройте IDE. Если вы используйте Windows, то вам также необходимо настроить WSL:
   - CLion
      - \[Windows\] [Настройка WSL](https://www.jetbrains.com/help/clion/how-to-use-wsl-development-environment-in-clion.html)
      - Настройку можно посмотреть в [записи семинара](https://disk.yandex.ru/i/8waWBV-L-FOKOw)
   - VS Code
      - \[Windows\] [Настройка WSL](https://code.visualstudio.com/docs/cpp/config-wsl)
      - Настройка описана в [инструкции](https://docs.google.com/document/d/1K0t05Bmqb3he3gW4ORQXfkVfFouS4FRT)
      - См. также [Гайд по настройке VSCode + WSL + CMake](docs/WSL.md)

Мы рекомендуем вам воспользоваться [Clion](https://www.jetbrains.com/clion/).
Скачайте бесплатную Community-версию, установите и запустите.
Проверьте, возможно ваше учебное заведение (т.ч. ШАД) предоставляет учебную лицензию на продукты
JetBrains. Тогда вы можете установить Professional версию бесплатно.

- Создайте новый проект (Create new project)
- Укажите путь до репозитория с задачами (см. пункт "Клонирование и настройка репозитория")
- TODO(sokolik): ...

### Сдача заданий <a id='send'/>

#### Получаем новые задания

В течении всего курса публичный репозиторий будет обновляться, в нём будут появляться новые задачи, а также возможно будут обновляться тесты и условия существующих задач. Подтянуть изменения из публичного репозитория можно с помощью команды `git pull upstream main`
Это загрузит последние обновления из публичного репозитория. Возможно нужно будет вмерджить
изменения (см лекцию про гит)

Если у вас ошибки после pull и просят выбрать команду -- ```git config pull.rebase false```

#### Решаем задачу

Код относящийся к отдельной задаче находится в отдельной директории темы и задачи
(`00_test/sum` и т.д.), нас будет интересовать её содержимое:

- условие задачи содержится в файле `readme.md`
- заготовка с кодом задачи обычно лежит в файле с именем задачи `sum.h`
- `BUILD` --- bazel-файл для сборки задачи.
- публичные тесты к задаче находятся в файле `test.cpp(или test_sum.cpp)`

Вам нужно дописать код в файл с именем задачи. (В условии будет написано какие файлы запускаются)

Обратите внимание, что в реальности в ```.h``` файлах не пишутся реализации функций и классов, но для простоты в задачах первых семинаров вам нужно будет писать реализации в ```.h``` файлах.

#### Проверяем себя из консоли

Все действия нужно производить из консоли, аналогично тому, как вы настраивали ключи и git.

Быстрая проверка тестов:

```bash
# Находясь в папке с задачей
bazel test :all
```

Запуск тестов под санитайзером ```Asan```

```bash
# Находясь в папке с задачей
$ bazel test :all --config=asan
```

Проверка `clang-tidy`

```bash
# Находясь в папке с задачей
$ bazel test :all --config=clang-tidy
```

Проверка `clang-format`

```bash
# Находясь в папке с задачей
$ bazel test :all --config=clang-format
```

Красивый ```clang-tidy``` и ```clang-format``` с цветами и подсказками

```bash
../../tools/testing/run_linter.sh ../../<группа>/<имя задачи>
# or
../../tools/testing/run_linter.sh .
```

Ошибки стиля выведутся: минус и как было, а потом плюс и как должно быть.

<details><summary><a>Картинка пример</a></summary><img src="https://i.imgur.com/kranX9Z.jpg" width=800/></details>

#### Отправляем задачу в тестирующую систему

Для этого задачу нужно просто закоммитить в ваш репозиторий и отправить в gitlab

```bash
# Находясь в корне репозитория
git add 00_test/sum/sum.h
git commit -m 'Add sum task'
git push origin main
```

Вы можете наблюдать за результатами тестирования на странице `CI/CD -> Jobs`(```CI/CD -> Pipelines```) в своём репозитории,
выбираем задачу, жмем на иконку статуса. gitlab показывает вывод консоли во время тестирования.

Там можно увидеть статусы посылок и результаты тестирования.
Выглядит это обычно так:

- Информация о последнем коммите и изменённых файлах (если в запушенных коммитах код решения задачи не был изменён, эта задача НЕ будет протестирована!)
- Для каждой тестируемой задачи (может быть несколько в одном коммите)
  - Проверка стиля (```clang-format```)
  - Статический анализ кода (```clang-tidy```)
  - Проверка запрещённых классов, библиотек
  - Запуск тестов и их результат
  - Запуск тестов и их результат(под санитайзерами ASAN)

<details><summary><a>Картинка</a></summary><img src="https://i.imgur.com/uwzONr9.png" width=800/></details>

Если хоть одна задача падает на тестах, в интерфейсе гитлаба запуск будет считаться неудавшимся (```failed```).
Если хоть одна задача в комплекте прошла - баллы за неё поставятся в систему независимо от остальных.
